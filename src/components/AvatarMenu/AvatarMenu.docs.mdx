import { Meta, Primary, Canvas, Controls, Story } from '@storybook/blocks';
import * as AvatarMenuStories from './AvatarMenu.stories';
import { AvatarMenu } from './AvatarMenu'

<Meta of={AvatarMenuStories} />

# AvatarMenu

> **Componente**: Menú contextual asociado al usuario autenticado — avatar + menú

El **`AvatarMenu`** es un componente de navegación diseñado para mostrar un menú
contextual asociado al avatar de un usuario autenticado. Está construido con
**React**, **TypeScript** y **Material UI (MUI)**, y encapsula la lógica de
acceso, foco y navegación mediante el hook `useAvatarMenu`.

---

## Objetivos y alcance

* Proveer un disparador visual (avatar) que abre un **menú accesible** con
  acciones relacionadas al usuario (perfil, configuración, cierre de sesión).
* Garantizar **navegación por teclado** y compatibilidad con lectores de pantalla.
* Ser flexible y personalizable mediante `menuItems`, `avatarProps` y `fullWidth`.
* Mantener separación de responsabilidades: lógica en el hook, UI en el JSX,
  estilos en el archivo `styles`.

---

## Demostración principal

<Primary />

> El ejemplo principal usa las stories registradas. Usa el panel de Controls para
> interactuar con las props en tiempo real.

---

## Props y API

## Props manuales
<table>
  <thead>
    <tr>
      <th>Prop</th>
      <th>Tipo</th>
      <th>Requerido</th>
      <th>Descripción</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>avatarUrl</td>
      <td><code>string</code></td>
      <td>Sí</td>
      <td>URL de la imagen del avatar</td>
    </tr>
    <tr>
      <td>username</td>
      <td><code>string</code></td>
      <td>Sí</td>
      <td>Nombre del usuario para aria-label</td>
    </tr>
    <tr>
      <td>menuItems</td>
      <td><code>AvatarMenuItem[]</code></td>
      <td>No</td>
      <td>Lista de items del menú</td>
    </tr>
    <tr>
      <td>avatarProps</td>
      <td><code>Omit&lt;MuiAvatarProps, 'src' | 'alt'&gt;</code></td>
      <td>No</td>
      <td>Props adicionales para Avatar de MUI</td>
    </tr>
    <tr>
      <td>fullWidth</td>
      <td><code>boolean</code></td>
      <td>No</td>
      <td>Si el trigger ocupa todo el ancho</td>
    </tr>
    <tr>
      <td>data-testid</td>
      <td><code>string</code></td>
      <td>No</td>
      <td>Identificador para pruebas</td>
    </tr>
  </tbody>
</table>

### Estructura de `AvatarMenuItem`

Cada elemento del menú tiene la siguiente forma (simplificada):

```ts
interface AvatarMenuItem {
  label: string;
  onClick: () => void;
  icon?: React.ReactNode;
  disabled?: boolean;
  divider?: boolean;
  'data-testid'?: string;
  menuItemProps?: Omit<MuiMenuItemProps, 'onClick'>;
}
```

---

## Accesibilidad (A11y)

* `aria-haspopup="true"` y `aria-expanded` en el trigger.
* `aria-controls` en el trigger apuntando al `menuId` cuando está abierto.
* `aria-labelledby` en el `MenuList` apuntando al trigger para vincular lecturas por screen-readers.
* Manejo de teclado:

  * `Enter` o `Space`: abre el menú desde el trigger.
  * `Escape`: cierra el menú y restaura foco.
  * `ArrowDown` / `ArrowUp`: navega entre ítems.
* Los `MenuItem` respetan `disabled` y exponen `aria-disabled`.
* `focusedIndex` y `autoFocus` se usan para indicar foco visual a nivel de item.

---

## Estilos y tokens

* `AvatarMenuRoot` controla `width`, `padding` y `borderRadius`.
* `AvatarContainer` es un flex container con gap dependiente de `theme.spacing`.
* `TriangleIndicator` es un triángulo CSS que rota según `$isOpen` — animación por `theme.transitions`.
* `UsernameText` se oculta en pantallas pequeñas mediante breakpoints.

Tokens referencia (ejemplos):

* `theme.palette.text.primary`
* `theme.shape.borderRadius`
* `theme.spacing(0.5)` / `theme.spacing(1.25)`

---

## Comportamiento visual y UX

* El menú se ancla con `anchorOrigin` y `transformOrigin` a `bottom/right` -> `top/right`.
* `MenuListProps.autoFocus` para foco automático en apertura y `dense` para compactar la lista.
* `MenuItem` aplica `sx` cuando está enfocado (sombra, border, borderRadius).
* Se respeta `menuItemProps.sx` si se proporciona.

---

## Testing (resumen de la suite existente)

* Renderizado inicial con `aria-expanded=false`.
* Apertura / cierre por click y verificación del rol `menu`.
* Ejecución de `onClick` de los ítems y cierre posterior.
* Uso de `DEFAULT_AVATAR_MENU_ITEMS` si no se pasan `menuItems`.
* Comportamiento con `avatarUrl` vacío (fallback).
* Menú con items deshabilitados (`aria-disabled`).
* Propagación `fullWidth` y estructura DOM.

---

## Stories incluidas

# AvatarMenu - Stories

> Enlaces a cada story individual del componente AvatarMenu.

<a href="?/iframe.html?globals=&id=navigation-avatarmenu--standard">Standard — Menú estándar con items por defecto</a>
<br />
<a href="?/iframe.html?globals=&id=navigation-avatarmenu--custom-actions&viewMode=story">CustomActions — Menú con items personalizados</a>
<br />
<a href="?/iframe.html?globals=&args=&id=navigation-avatarmenu--avatar-fallback&viewMode=story" >AvatarFallback — Sin imagen de avatar</a>
<br />
<a href="?/iframe.html?globals=&args=&id=navigation-avatarmenu--empty-menu&viewMode=story">EmptyMenu — Menú vacío</a>
<br />
<a href="?/iframe.html?globals=&args=&id=navigation-avatarmenu--disabled-items&viewMode=story">DisabledItems — Items deshabilitados</a>
<br />
<a href="?/iframe.html?globals=&args=&id=navigation-avatarmenu--layout-variants&viewMode=story">LayoutVariants — fullWidth y sin username</a>

---

## Ejemplos de uso

```tsx
<AvatarMenu
  avatarUrl="/images/user.jpg"
  username="Alex Méndez"
  menuItems={[
    { label: 'Perfil', onClick: () => navigate('/profile') },
    { label: 'Cerrar Sesión', onClick: logout, divider: true }
  ]}
/>
```

```tsx
<AvatarMenu
  avatarUrl=""
  username="Usuario"
  avatarProps={{ sx: { width: 36, height: 36 } }}
  menuItems={[
    { label: 'Modo Oscuro', onClick: toggleDarkMode },
    { label: 'Soporte', onClick: openHelp }
  ]}
  fullWidth
/>
```

---
